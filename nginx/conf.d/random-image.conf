server {
    listen 80 default_server;
    server_name _;  # Catch all server name

    root /var/www/images;

    # Basic security headers
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";

    location / {
        limit_req zone=one burst=10 nodelay;
        default_type text/html;
        content_by_lua_block {
            -- Generate random query parameter to prevent caching
            math.randomseed(ngx.time() * 1000)
            local random_value = math.random(100000, 999999)

            local page = string.format([[
            <!DOCTYPE html>
            <html>
            <head>
                <title>Random Image</title>
            </head>
            <body>
                <img src="/random-image?v=%d" alt="Random Image" />
            </body>
            </html>
            ]], random_value)
            ngx.say(page)
        }
    }

    # Serve static files securely (for direct access only)
    location ~ \.(jpg|jpeg|png|gif)$ {
        # No caching for random image display
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }
}